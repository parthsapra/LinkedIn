import { isObject, isEqual } from '../functions/utils';
import { getObject } from "../functions/get-instance";
export class List {
    constructor(values, model) {
        this.model = model;
        this._entities = new Array();
        this.build(values);
    }
    [Symbol.iterator]() {
        let pointer = 0;
        let entities = this._entities;
        return {
            next() {
                if (pointer < entities.length) {
                    let index = pointer++;
                    if (this.model && entities[index].constructor !== this.model)
                        entities[index] = getObject(this.model, [], this.object[index]);
                    return {
                        done: false,
                        value: entities[index]
                    };
                }
                else {
                    return {
                        done: true,
                        value: null
                    };
                }
            }
        };
    }
    add(entity) {
        this._entities.push(this.createObject(entity));
    }
    addRange(entities) {
        for (let entity of entities)
            this.add(entity);
    }
    all(predicate) {
        return this._entities.every(predicate);
    }
    any(predicate) {
        return this._entities.some(predicate);
    }
    average(transform) {
        return this.sum(transform) / this.count(transform);
    }
    contains(element) {
        return this._entities.some(x => x === element);
    }
    concat(items) {
        if (items) {
            this.addRange(items);
            return new List(this._entities, this.model);
        }
        return undefined;
    }
    count(predicate) {
        return predicate ? this.where(predicate).count() : this._entities.length;
    }
    where(predicate) {
        return new List(this._entities.filter(predicate), this.model);
    }
    distinct() {
        return this.where((value, index, iter) => (isObject(value)) ?
            iter.findIndex(t => isEqual(t, value)) == index :
            iter.indexOf(value) === index);
    }
    distinctBy(keySelector) {
        const entityGroup = this.groupBy(keySelector);
        return Object.keys(entityGroup).reduce((resource, key) => {
            resource.add(entityGroup[key][0]);
            return resource;
        }, new List());
    }
    elementAt(index) {
        if (this._entities.length > index && index >= 0)
            return this._entities[index];
    }
    except(collection) {
        return this.where(x => !collection.contains(x));
    }
    first(predicate) {
        if (this.count()) {
            return predicate ? this.where(predicate).first() : this._entities[0];
        }
        else {
            throw new Error('No result found.');
        }
    }
    firstOrDefault(predicate) {
        return this.count() ? this.first(predicate) : undefined;
    }
    forEach(action) {
        return this._entities.forEach(action);
    }
    aggregate(accumulator, initialValue) {
        return this._entities.reduce(accumulator, initialValue);
    }
    groupBy(grouper, mapper) {
        if (!mapper)
            mapper = value => (value);
        return this.aggregate((ac, v) => (ac[grouper(v)] ? ac[grouper(v)].push(mapper(v)) : ac[grouper(v)] = [mapper(v)], ac), {});
    }
    insert(index, element) {
        if (index < 0 || index > this._entities.length) {
            throw new Error('Index is out of range.');
        }
        this._entities.splice(index, 0, this.createObject(element));
    }
    join(seperator) {
        return this._entities ? this._entities.join(seperator) : null;
    }
    last(predicate) {
        if (this.count()) {
            return predicate ? this.where(predicate).last() : this._entities[this.count() - 1];
        }
        else {
            throw Error('No result found.');
        }
    }
    lastOrDefault(predicate) {
        return this.count() ? this.last(predicate) : undefined;
    }
    get length() {
        return this._entities ? this._entities.length : 0;
    }
    max(predicate) {
        if (!predicate)
            return this.aggregate((x, y) => x > y ? x : y);
        else
            return Math.max(...this._entities.map(predicate));
    }
    maxBy(keySelector) {
        const entityGroup = this.groupBy(keySelector);
        let keys = Object.keys(entityGroup);
        let maxKey = Math.max(...keys);
        return entityGroup[maxKey][0];
    }
    min(predicate) {
        if (!predicate)
            return this.aggregate((x, y) => x < y ? x : y);
        else
            return Math.min(...this._entities.map(predicate));
    }
    minBy(keySelector) {
        const entityGroup = this.groupBy(keySelector);
        let keys = Object.keys(entityGroup);
        let minKey = Math.min(...keys);
        return entityGroup[minKey][0];
    }
    orderBy(predicate) {
        return new List(this._entities.sort(this.customSort(predicate, false)));
    }
    orderByDescending(predicate) {
        return new List(this._entities.sort(this.customSort(predicate, true)));
    }
    pop() {
        return this._entities.pop();
    }
    remove(element) {
        return this._entities.indexOf(element) !== -1 ? (this.removeAt(this._entities.indexOf(element)), true) : false;
    }
    removeAll(predicate) {
        return this.where(this._negate(predicate));
    }
    removeAt(index) {
        this._entities.splice(index, 1);
    }
    reverse() {
        return this._entities ? new List(this._entities.reverse(), this.model) : new List();
    }
    select(mapper) {
        return this._entities.map(mapper);
    }
    single(predicate) {
        if (this.count() !== 1) {
            throw new Error('Item does not contain one element.');
        }
        else {
            return this.first(predicate);
        }
    }
    singleOrDefault(predicate) {
        return this.count() ? this.first(predicate) : undefined;
    }
    shift() {
        return this._entities ? this._entities.shift() : undefined;
    }
    skip(amount) {
        return this._entities.slice(Math.max(0, amount));
    }
    sum(transform) {
        return transform ? this.select(transform).sum() : this.aggregate((ac, v) => ac += (+v), 0);
    }
    take(amount) {
        return this._entities.slice(0, Math.max(0, amount));
    }
    get toLocaleString() {
        return this._entities ? this._entities.toLocaleString() : null;
    }
    get toString() {
        return this._entities ? this._entities.toString() : null;
    }
    _negate(predicate) {
        return function () {
            return !predicate.apply(this, arguments);
        };
    }
    customSort(predicate, orderByDescending) {
        return (a, b) => {
            const first = predicate(a);
            const second = predicate(b);
            if (first > second) {
                return !orderByDescending ? 1 : -1;
            }
            else if (first < second) {
                return !orderByDescending ? -1 : 1;
            }
            else {
                return 0;
            }
        };
    }
    build(values) {
        if (values && values.length > 0) {
            this.addRange(values);
        }
    }
    createObject(object) {
        if (this.model && object.constructor !== this.model)
            return getObject(this.model, [], object);
        return object;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0ByeHdlYi9nZW5lcmljcy8iLCJzb3VyY2VzIjpbIm1vZGVscy9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDdEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRXRELE1BQU0sT0FBTyxJQUFJO0lBRWIsWUFBWSxNQUFZLEVBQVUsS0FBZTtRQUFmLFVBQUssR0FBTCxLQUFLLENBQVU7UUFEekMsY0FBUyxHQUFRLElBQUksS0FBSyxFQUFLLENBQUM7UUFFcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBQ2IsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDOUIsT0FBTztZQUNILElBQUk7Z0JBQ0EsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRTtvQkFDM0IsSUFBSSxLQUFLLEdBQUcsT0FBTyxFQUFFLENBQUE7b0JBQ3JCLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxLQUFLLElBQUksQ0FBQyxLQUFLO3dCQUN4RCxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTtvQkFDbkUsT0FBTzt3QkFDSCxJQUFJLEVBQUUsS0FBSzt3QkFDWCxLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQztxQkFDekIsQ0FBQTtpQkFDSjtxQkFBTTtvQkFDSCxPQUFPO3dCQUNILElBQUksRUFBRSxJQUFJO3dCQUNWLEtB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ZnVuY3Rpb25zL3R5cGUnXHJcbmltcG9ydCB7IGlzT2JqZWN0LCBpc0VxdWFsIH0gZnJvbSAnLi4vZnVuY3Rpb25zL3V0aWxzJ1xyXG5pbXBvcnQgeyBnZXRPYmplY3QgfSBmcm9tIFwiLi4vZnVuY3Rpb25zL2dldC1pbnN0YW5jZVwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIExpc3Q8VD4gIHtcclxuICAgIHByaXZhdGUgX2VudGl0aWVzOiBUW10gPSBuZXcgQXJyYXk8VD4oKTtcclxuICAgIGNvbnN0cnVjdG9yKHZhbHVlcz86IFRbXSwgcHJpdmF0ZSBtb2RlbD86IFR5cGU8VD4pIHtcclxuICAgICAgICB0aGlzLmJ1aWxkKHZhbHVlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgW1N5bWJvbC5pdGVyYXRvcl0oKTogSXRlcmF0b3I8VD4ge1xyXG4gICAgICAgIGxldCBwb2ludGVyID0gMDtcclxuICAgICAgICBsZXQgZW50aXRpZXMgPSB0aGlzLl9lbnRpdGllcztcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBuZXh0KCk6IEl0ZXJhdG9yUmVzdWx0PFQ+IHtcclxuICAgICAgICAgICAgICAgIGlmIChwb2ludGVyIDwgZW50aXRpZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGluZGV4ID0gcG9pbnRlcisrXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubW9kZWwgJiYgZW50aXRpZXNbaW5kZXhdLmNvbnN0cnVjdG9yICE9PSB0aGlzLm1vZGVsKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbnRpdGllc1tpbmRleF0gPSBnZXRPYmplY3QodGhpcy5tb2RlbCwgW10sIHRoaXMub2JqZWN0W2luZGV4XSlcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGVudGl0aWVzW2luZGV4XVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZTogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG51bGxcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBhZGQoZW50aXR5OiBUKSB7XHJcbiAgICAgICAgdGhpcy5fZW50aXRpZXMucHVzaCh0aGlzLmNyZWF0ZU9iamVjdChlbnRpdHkpKTtcclxuICAgIH1cclxuXHJcbiAgICBhZGRSYW5nZShlbnRpdGllczogVFtdKSB7XHJcbiAgICAgICAgZm9yIChsZXQgZW50aXR5IG9mIGVudGl0aWVzKVxyXG4gICAgICAgICAgICB0aGlzLmFkZChlbnRpdHkpO1xyXG4gICAgfVxyXG5cclxuICAgIGFsbChwcmVkaWNhdGU6ICh2YWx1ZT86IFQsIGluZGV4PzogbnVtYmVyLCBsaXN0PzogVFtdKSA9PiBib29sZWFuKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzLmV2ZXJ5KHByZWRpY2F0ZSk7XHJcbiAgICB9XHJcbiAgICBhbnkocHJlZGljYXRlOiAodmFsdWU/OiBULCBpbmRleD86IG51bWJlciwgbGlzdD86IFRbXSkgPT4gYm9vbGVhbik6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lbnRpdGllcy5zb21lKHByZWRpY2F0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgYXZlcmFnZSh0cmFuc2Zvcm0/OiAodmFsdWU/OiBULCBpbmRleD86IG51bWJlciwgbGlzdD86IFRbXSkgPT4gYW55KTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zdW0odHJhbnNmb3JtKSAvIHRoaXMuY291bnQodHJhbnNmb3JtKTtcclxuICAgIH1cclxuXHJcbiAgICBjb250YWlucyhlbGVtZW50OiBUKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzLnNvbWUoeCA9PiB4ID09PSBlbGVtZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25jYXQoaXRlbXM6IFRbXSk6IExpc3Q8VD4ge1xyXG4gICAgICAgIGlmIChpdGVtcykge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFJhbmdlKGl0ZW1zKTtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBMaXN0PFQ+KHRoaXMuX2VudGl0aWVzLCB0aGlzLm1vZGVsKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBjb3VudChwcmVkaWNhdGU/OiAodmFsdWU/OiBULCBpbmRleD86IG51bWJlciwgbGlzdD86IFRbXSkgPT4gYm9vbGVhbik6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHByZWRpY2F0ZSA/IHRoaXMud2hlcmUocHJlZGljYXRlKS5jb3VudCgpIDogdGhpcy5fZW50aXRpZXMubGVuZ3RoO1xyXG4gICAgfVxyXG5cclxuICAgIHdoZXJlKHByZWRpY2F0ZTogKHZhbHVlPzogVCwgaW5kZXg/OiBudW1iZXIsIGxpc3Q/OiBUW10pID0+IGJvb2xlYW4pOiBMaXN0PFQ+IHtcclxuICAgICAgICByZXR1cm4gbmV3IExpc3Q8VD4odGhpcy5fZW50aXRpZXMuZmlsdGVyKHByZWRpY2F0ZSksIHRoaXMubW9kZWwpO1xyXG4gICAgfVxyXG5cclxuICAgIGRpc3RpbmN0KCk6IExpc3Q8VD4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndoZXJlKCh2YWx1ZSwgaW5kZXgsIGl0ZXIpID0+XHJcbiAgICAgICAgICAgIChpc09iamVjdCh2YWx1ZSkpID9cclxuICAgICAgICAgICAgICAgIGl0ZXIuZmluZEluZGV4KHQgPT4gaXNFcXVhbCh0LCB2YWx1ZSkpID09IGluZGV4IDpcclxuICAgICAgICAgICAgICAgIGl0ZXIuaW5kZXhPZih2YWx1ZSkgPT09IGluZGV4XHJcbiAgICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIGRpc3RpbmN0Qnkoa2V5U2VsZWN0b3I6IChrZXk6IFQpID0+IHN0cmluZyB8IG51bWJlcik6IExpc3Q8VD4ge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eUdyb3VwID0gdGhpcy5ncm91cEJ5KGtleVNlbGVjdG9yKVxyXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhlbnRpdHlHcm91cCkucmVkdWNlKChyZXNvdXJjZTogTGlzdDxUPiwga2V5KSA9PiB7XHJcbiAgICAgICAgICAgIHJlc291cmNlLmFkZChlbnRpdHlHcm91cFtrZXldWzBdKVxyXG4gICAgICAgICAgICByZXR1cm4gcmVzb3VyY2VcclxuICAgICAgICB9LCBuZXcgTGlzdDxUPigpKVxyXG4gICAgfVxyXG5cclxuICAgIGVsZW1lbnRBdChpbmRleDogbnVtYmVyKTogVCB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2VudGl0aWVzLmxlbmd0aCA+IGluZGV4ICYmIGluZGV4ID49IDApXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9lbnRpdGllc1tpbmRleF07XHJcbiAgICB9XHJcblxyXG4gICAgZXhjZXB0KGNvbGxlY3Rpb246IExpc3Q8VD4pOiBMaXN0PFQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy53aGVyZSh4ID0+ICFjb2xsZWN0aW9uLmNvbnRhaW5zKHgpKVxyXG4gICAgfVxyXG5cclxuICAgIGZpcnN0KHByZWRpY2F0ZT86ICh2YWx1ZT86IFQsIGluZGV4PzogbnVtYmVyLCBsaXN0PzogVFtdKSA9PiBib29sZWFuKTogVCB8IEVycm9yIHtcclxuICAgICAgICBpZiAodGhpcy5jb3VudCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmVkaWNhdGUgPyB0aGlzLndoZXJlKHByZWRpY2F0ZSkuZmlyc3QoKSA6IHRoaXMuX2VudGl0aWVzWzBdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcmVzdWx0IGZvdW5kLicpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmaXJzdE9yRGVmYXVsdChwcmVkaWNhdGU/OiAodmFsdWU/OiBULCBpbmRleD86IG51bWJlciwgbGlzdD86IFRbXSkgPT4gYm9vbGVhbik6IFQgfCBFcnJvciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY291bnQoKSA/IHRoaXMuZmlyc3QocHJlZGljYXRlKSA6IHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBmb3JFYWNoKGFjdGlvbjogKHZhbHVlPzogVCwgaW5kZXg/OiBudW1iZXIsIGxpc3Q/OiBUW10pID0+IGFueSk6IHZvaWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lbnRpdGllcy5mb3JFYWNoKGFjdGlvbilcclxuICAgIH1cclxuXHJcblxyXG4gICAgYWdncmVnYXRlPFU+KGFjY3VtdWxhdG9yOiAoYWNjdW06IFUsIHZhbHVlPzogVCwgaW5kZXg/OiBudW1iZXIsIGxpc3Q/OiBUW10pID0+IGFueSwgaW5pdGlhbFZhbHVlPzogVSk6IGFueSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzLnJlZHVjZShhY2N1bXVsYXRvciwgaW5pdGlhbFZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICBncm91cEJ5KGdyb3VwZXI6IChrZXk6IFQpID0+IGFueSwgbWFwcGVyPzogKGVsZW1lbnQ6IFQpID0+IGFueSk6IGFueSB7XHJcbiAgICAgICAgaWYgKCFtYXBwZXIpXHJcbiAgICAgICAgICAgIG1hcHBlciA9IHZhbHVlID0+ICh2YWx1ZSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYWdncmVnYXRlXHJcbiAgICAgICAgICAgICgoYWMsIHYpID0+ICgoPGFueT5hYylbZ3JvdXBlcih2KV0gPyAoPGFueT5hYylbZ3JvdXBlcih2KV0ucHVzaChtYXBwZXIodikpIDogKDxhbnk+YWMpW2dyb3VwZXIodildID0gW21hcHBlcih2KV0sIGFjKSwge30pO1xyXG4gICAgfVxyXG5cclxuICAgIGluc2VydChpbmRleDogbnVtYmVyLCBlbGVtZW50OiBUKTogdm9pZCB8IEVycm9yIHtcclxuICAgICAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID4gdGhpcy5fZW50aXRpZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW5kZXggaXMgb3V0IG9mIHJhbmdlLicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl9lbnRpdGllcy5zcGxpY2UoaW5kZXgsIDAsIHRoaXMuY3JlYXRlT2JqZWN0KGVsZW1lbnQpKTtcclxuICAgIH1cclxuXHJcbiAgICBqb2luKHNlcGVyYXRvcj86IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzID8gdGhpcy5fZW50aXRpZXMuam9pbihzZXBlcmF0b3IpIDogbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBsYXN0KHByZWRpY2F0ZT86ICh2YWx1ZT86IFQsIGluZGV4PzogbnVtYmVyLCBsaXN0PzogVFtdKSA9PiBib29sZWFuKTogVCB8IEVycm9yIHtcclxuICAgICAgICBpZiAodGhpcy5jb3VudCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmVkaWNhdGUgPyB0aGlzLndoZXJlKHByZWRpY2F0ZSkubGFzdCgpIDogdGhpcy5fZW50aXRpZXNbdGhpcy5jb3VudCgpIC0gMV07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ05vIHJlc3VsdCBmb3VuZC4nKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbGFzdE9yRGVmYXVsdChwcmVkaWNhdGU/OiAodmFsdWU/OiBULCBpbmRleD86IG51bWJlciwgbGlzdD86IFRbXSkgPT4gYm9vbGVhbik6IFQgfCBFcnJvciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY291bnQoKSA/IHRoaXMubGFzdChwcmVkaWNhdGUpIDogdW5kZWZpbmVkO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBsZW5ndGgoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzID8gdGhpcy5fZW50aXRpZXMubGVuZ3RoIDogMDtcclxuICAgIH1cclxuXHJcbiAgICBtYXgoKTogbnVtYmVyXHJcbiAgICBtYXgocHJlZGljYXRlOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIsIGxpc3Q6IFRbXSkgPT4gbnVtYmVyKTogbnVtYmVyXHJcbiAgICBtYXgocHJlZGljYXRlPzogKHZhbHVlOiBULCBpbmRleDogbnVtYmVyLCBsaXN0OiBUW10pID0+IG51bWJlcik6IG51bWJlciB7XHJcbiAgICAgICAgaWYgKCFwcmVkaWNhdGUpXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmFnZ3JlZ2F0ZSgoeCwgeSkgPT4geCA+IHkgPyB4IDogeSk7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoLi4udGhpcy5fZW50aXRpZXMubWFwKHByZWRpY2F0ZSkpXHJcbiAgICB9XHJcblxyXG4gICAgbWF4Qnkoa2V5U2VsZWN0b3I6IChrZXk6IFQpID0+IG51bWJlcik6IFQge1xyXG4gICAgICAgIGNvbnN0IGVudGl0eUdyb3VwID0gdGhpcy5ncm91cEJ5KGtleVNlbGVjdG9yKVxyXG4gICAgICAgIGxldCBrZXlzOiBhbnlbXSA9IE9iamVjdC5rZXlzKGVudGl0eUdyb3VwKTtcclxuICAgICAgICBsZXQgbWF4S2V5ID0gTWF0aC5tYXgoLi4ua2V5cyk7XHJcbiAgICAgICAgcmV0dXJuIGVudGl0eUdyb3VwW21heEtleV1bMF07XHJcbiAgICB9XHJcblxyXG4gICAgbWluKCk6IG51bWJlclxyXG4gICAgbWluKHByZWRpY2F0ZTogKHZhbHVlOiBULCBpbmRleDogbnVtYmVyLCBsaXN0OiBUW10pID0+IG51bWJlcik6IG51bWJlclxyXG4gICAgbWluKHByZWRpY2F0ZT86ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlciwgbGlzdDogVFtdKSA9PiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIGlmICghcHJlZGljYXRlKVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5hZ2dyZWdhdGUoKHgsIHkpID0+IHggPCB5ID8geCA6IHkpO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKC4uLnRoaXMuX2VudGl0aWVzLm1hcChwcmVkaWNhdGUpKVxyXG4gICAgfVxyXG5cclxuICAgIG1pbkJ5KGtleVNlbGVjdG9yOiAoa2V5OiBUKSA9PiBudW1iZXIpOiBUIHtcclxuICAgICAgICBjb25zdCBlbnRpdHlHcm91cCA9IHRoaXMuZ3JvdXBCeShrZXlTZWxlY3RvcilcclxuICAgICAgICBsZXQga2V5czogYW55W10gPSBPYmplY3Qua2V5cyhlbnRpdHlHcm91cCk7XHJcbiAgICAgICAgbGV0IG1pbktleSA9IE1hdGgubWluKC4uLmtleXMpO1xyXG4gICAgICAgIHJldHVybiBlbnRpdHlHcm91cFttaW5LZXldWzBdO1xyXG4gICAgfVxyXG5cclxuICAgIG9yZGVyQnkocHJlZGljYXRlOiAoa2V5OiBUKSA9PiBhbnkpOiBMaXN0PFQ+IHtcclxuICAgICAgICByZXR1cm4gbmV3IExpc3Q8VD4odGhpcy5fZW50aXRpZXMuc29ydCh0aGlzLmN1c3RvbVNvcnQocHJlZGljYXRlLCBmYWxzZSkpKTtcclxuICAgIH1cclxuXHJcbiAgICBvcmRlckJ5RGVzY2VuZGluZyhwcmVkaWNhdGU6IChrZXk6IFQpID0+IGFueSk6IExpc3Q8VD4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgTGlzdDxUPih0aGlzLl9lbnRpdGllcy5zb3J0KHRoaXMuY3VzdG9tU29ydChwcmVkaWNhdGUsIHRydWUpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcG9wKCk6IFQgfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lbnRpdGllcy5wb3AoKTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmUoZWxlbWVudDogVCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lbnRpdGllcy5pbmRleE9mKGVsZW1lbnQpICE9PSAtMSA/ICh0aGlzLnJlbW92ZUF0KHRoaXMuX2VudGl0aWVzLmluZGV4T2YoZWxlbWVudCkpLCB0cnVlKSA6IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmVtb3ZlQWxsKHByZWRpY2F0ZTogKHZhbHVlPzogVCwgaW5kZXg/OiBudW1iZXIsIGxpc3Q/OiBUW10pID0+IGJvb2xlYW4pOiBMaXN0PFQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy53aGVyZSh0aGlzLl9uZWdhdGUocHJlZGljYXRlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlQXQoaW5kZXg6IG51bWJlcik6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuX2VudGl0aWVzLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV2ZXJzZSgpOiBMaXN0PFQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZW50aXRpZXMgPyBuZXcgTGlzdDxUPih0aGlzLl9lbnRpdGllcy5yZXZlcnNlKCksIHRoaXMubW9kZWwpIDogbmV3IExpc3Q8VD4oKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgc2VsZWN0KG1hcHBlcjogKHZhbHVlPzogVCwgaW5kZXg/OiBudW1iZXIsIGxpc3Q/OiBUW10pID0+IGFueSk6IGFueSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzLm1hcChtYXBwZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNpbmdsZShwcmVkaWNhdGU/OiAodmFsdWU/OiBULCBpbmRleD86IG51bWJlciwgbGlzdD86IFRbXSkgPT4gYm9vbGVhbik6IFQgfCBFcnJvciB7XHJcbiAgICAgICAgaWYgKHRoaXMuY291bnQoKSAhPT0gMSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0l0ZW0gZG9lcyBub3QgY29udGFpbiBvbmUgZWxlbWVudC4nKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5maXJzdChwcmVkaWNhdGUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzaW5nbGVPckRlZmF1bHQocHJlZGljYXRlPzogKHZhbHVlPzogVCwgaW5kZXg/OiBudW1iZXIsIGxpc3Q/OiBUW10pID0+IGJvb2xlYW4pOiBUIHwgRXJyb3Ige1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNvdW50KCkgPyB0aGlzLmZpcnN0KHByZWRpY2F0ZSkgOiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgc2hpZnQoKTogVCB8IHVuZGVmaW5lZCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzID8gdGhpcy5fZW50aXRpZXMuc2hpZnQoKSA6IHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBza2lwKGFtb3VudDogbnVtYmVyKTogVFtdIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZW50aXRpZXMuc2xpY2UoTWF0aC5tYXgoMCwgYW1vdW50KSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3VtKHRyYW5zZm9ybT86ICh2YWx1ZT86IFQsIGluZGV4PzogbnVtYmVyLCBsaXN0PzogVFtdKSA9PiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0cmFuc2Zvcm0gPyB0aGlzLnNlbGVjdCh0cmFuc2Zvcm0pLnN1bSgpIDogdGhpcy5hZ2dyZWdhdGUoKGFjLCB2KSA9PiBhYyArPSAoK3YpLCAwKTtcclxuICAgIH1cclxuXHJcbiAgICB0YWtlKGFtb3VudDogbnVtYmVyKTogTGlzdDxUPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzLnNsaWNlKDAsIE1hdGgubWF4KDAsIGFtb3VudCkpIGFzIGFueTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdG9Mb2NhbGVTdHJpbmcoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VudGl0aWVzID8gdGhpcy5fZW50aXRpZXMudG9Mb2NhbGVTdHJpbmcoKSA6IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHRvU3RyaW5nKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9lbnRpdGllcyA/IHRoaXMuX2VudGl0aWVzLnRvU3RyaW5nKCkgOiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX25lZ2F0ZTxUPihwcmVkaWNhdGU6ICh2YWx1ZT86IFQsIGluZGV4PzogbnVtYmVyLCBsaXN0PzogVFtdKSA9PiBib29sZWFuKTogKCkgPT4gYW55IHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCk6IGFueSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhcHJlZGljYXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGN1c3RvbVNvcnQocHJlZGljYXRlOiAoa2V5OiBUKSA9PiBhbnksIG9yZGVyQnlEZXNjZW5kaW5nOiBib29sZWFuKSB7XHJcbiAgICAgICAgcmV0dXJuIChhOiBULCBiOiBUKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZpcnN0ID0gcHJlZGljYXRlKGEpXHJcbiAgICAgICAgICAgIGNvbnN0IHNlY29uZCA9IHByZWRpY2F0ZShiKVxyXG4gICAgICAgICAgICBpZiAoZmlyc3QgPiBzZWNvbmQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAhb3JkZXJCeURlc2NlbmRpbmcgPyAxIDogLTFcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChmaXJzdCA8IHNlY29uZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICFvcmRlckJ5RGVzY2VuZGluZyA/IC0xIDogMVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDBcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGJ1aWxkKHZhbHVlczogVFtdKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlcyAmJiB2YWx1ZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFJhbmdlKHZhbHVlcylcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVPYmplY3Qob2JqZWN0KSB7XHJcbiAgICAgICAgaWYgKHRoaXMubW9kZWwgJiYgb2JqZWN0LmNvbnN0cnVjdG9yICE9PSB0aGlzLm1vZGVsKVxyXG4gICAgICAgICAgICByZXR1cm4gZ2V0T2JqZWN0KHRoaXMubW9kZWwsIFtdLCBvYmplY3QpXHJcbiAgICAgICAgcmV0dXJuIG9iamVjdDtcclxuICAgIH1cclxufSJdfQ==